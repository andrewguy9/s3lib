#!/usr/bin/env python

import argparse
from os.path import expanduser
import base64
import hmac, hashlib

def load_creds(path):
    with open(path, "r") as f:
        access_id = f.readline().strip()
        secret_key = f.readline().strip()
        return (access_id, secret_key)

parser = argparse.ArgumentParser("Sign an S3 form.")
parser.add_argument('--creds', type=str, dest='creds', action='store', default=expanduser("~/.s3"), help='Name of file to find aws access id and secret key')
parser.add_argument('file', type=str)

def main():
  args = parser.parse_args()
  (_, secret_key) = load_creds(args.creds)
  with open(args.file, 'r') as f:
    policy_document = f.read()
  policy = base64.b64encode(policy_document)
  signature = base64.b64encode(hmac.new(secret_key, policy, hashlib.sha1).digest())
  print policy
  print signature

if __name__ == '__main__':
    main()

